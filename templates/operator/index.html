{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Оператор • Электронная очередь</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <style>
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);display:inline-block}
    .spacer{flex:1}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">

      <div class="row">
        <div>
          <h1 class="h1" style="margin:0">Оператор</h1>
          <p class="p muted" style="margin:6px 0 0 0">
            Вошли как: <b>{{ request.user.username }}</b>
            {% if desk %} • Desk: <b>{{ desk }}</b>{% endif %}
          </p>
        </div>

        <div class="spacer"></div>

        <!-- ✅ Правильный выход: POST -->
        <form method="post" action="{% url 'operator_logout' %}">
          {% csrf_token %}
          <button type="submit" class="btn secondary">Выйти</button>
        </form>
      </div>

      <div class="row" style="margin-top:12px">
        <input id="desk" class="input" placeholder="Desk (например 3)" style="max-width:220px"
               value="{% if desk %}{{ desk }}{% endif %}">
        <button class="btn" onclick="loadPending()">Обновить очередь</button>
        <button class="btn" onclick="callNext()">Вызвать следующего</button>
      </div>

      <div style="margin-top:12px">
        <div class="pill">Текущий вызванный: <span id="current">—</span></div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Номер</th>
            <th>Услуга</th>
            <th>Категория</th>
            <th>ФИО</th>
            <th>Телефон</th>
            <th>Статус</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div id="toast" class="toast"></div>
    </div>
  </div>

  <script src="{% static 'assets/js/ui.js' %}"></script>
  <script>
    function toast(msg){ showToast(msg); }

    async function loadPending(){
      const desk = document.getElementById("desk").value.trim();
      if(!desk){ toast("Введите desk"); return; }

      const r = await fetch(`/api/tickets/pending/?desk=${encodeURIComponent(desk)}`);
      if(!r.ok){
        toast("Ошибка загрузки очереди");
        return;
      }
      const data = await r.json();

      const tbody = document.getElementById("rows");
      tbody.innerHTML = "";

      (data || []).forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${t.number}</b></td>
          <td>${t.service}</td>
          <td>${t.category || "-"}</td>
          <td>${t.fio || "-"}</td>
          <td>${t.phone || "-"}</td>
          <td>${t.status}</td>
          <td>
            <button class="btn secondary" onclick="markDone(${t.id})">DONE</button>
            <button class="btn secondary" onclick="markCancel(${t.id})">CANCEL</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      toast("Очередь обновлена");
    }

    async function callNext(){
      const desk = document.getElementById("desk").value.trim();
      if(!desk){ toast("Введите desk"); return; }

      const r = await fetch(`/api/tickets/next/`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ desk: Number(desk) })
      });

      if(!r.ok){
        const txt = await r.text();
        toast("Нет талонов или ошибка: " + txt);
        return;
      }

      const t = await r.json();
      document.getElementById("current").textContent = `${t.number} (Desk ${t.desk})`;
      toast("Вызван: " + t.number);

      loadPending();
    }

    async function markDone(id){
      const r = await fetch(`/api/tickets/${id}/done/`, { method:"POST" });
      if(r.ok){ toast("DONE"); loadPending(); }
      else toast("Ошибка DONE");
    }

    async function markCancel(id){
      const r = await fetch(`/api/tickets/${id}/cancel/`, { method:"POST" });
      if(r.ok){ toast("CANCELLED"); loadPending(); }
      else toast("Ошибка CANCEL");
    }
  </script>
</body>
</html>
