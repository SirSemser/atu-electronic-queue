{% load static %}
<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>АТУ • Грант конкурсы</title>
  <link rel="stylesheet" href="{% static 'assets/css/app.css' %}">
  <!-- Шрифты с поддержкой казахского -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    #programsWrap.reveal {
      display:block !important;
      opacity:0;
      transform: translateY(8px);
      transition: all .3s ease;
    }
    #programsWrap.reveal.show {
      opacity:1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="title" data-i18n="org_name">АТУ</div>
        <div class="sub" data-i18n="org_sub">Қабылдау комиссиясы • Электрондық кезек</div>
      </div>

      <div class="lang">
        <button data-lang-btn="kz" onclick="I18N.setLang('kz'); I18N.load();">KZ</button>
        <button data-lang-btn="ru" onclick="I18N.setLang('ru'); I18N.load();">RU</button>
        <button data-lang-btn="en" onclick="I18N.setLang('en'); I18N.load();">EN</button>
      </div>
    </div>

    <div class="card">
      <h1 class="h1">Грант конкурсына қатысу</h1>
      <p class="p">Категорияны таңдаңыз. Кейін профиль/бағдарлама таңдалады.</p>

      <div class="grid" style="margin-top:12px">
        <button class="btn secondary" onclick="go('/app/service/')" data-i18n="btn_back">Артқа</button>
      </div>

      <!-- STEP 1: CATEGORY -->
      <div id="step1" style="margin-top:14px">
        <div class="card" style="padding:14px">
          <div class="small">Категория</div>
          <div class="grid" style="margin-top:10px">
            <button class="btn" onclick="chooseCategory('after11')" data-i18n="cat_after11">11 сыныптан кейін</button>
            <button class="btn" onclick="chooseCategory('afterCollege')" data-i18n="cat_afterCollege">Колледжден кейін</button>
            <button class="btn" onclick="chooseCategory('foreign')" data-i18n="cat_foreign">Шетел азаматы / Диаспора</button>
            <button class="btn" onclick="chooseCategory('master')" data-i18n="cat_masters">Магистратура / Докторантура</button>
            <button class="btn" onclick="chooseCategory('army')" data-i18n="cat_army">Әскер</button>
          </div>
        </div>
      </div>

      <!-- DOCS -->
      <div id="docs" style="display:none; margin-top:14px">
        <div class="card" style="padding:14px">
          <div class="small">Ескерту</div>
          <div id="docsList" class="p" style="margin-top:10px; line-height:1.75"></div>
        </div>
      </div>

      <!-- STEP 2: PROFILE SUBJECTS -->
      <div id="profileWrap" style="display:none; margin-top:14px">
        <div class="card" style="padding:14px">
          <div class="small" data-i18n="adm_profile_title">Профильдік пәндер</div>
          <div class="grid two" style="margin-top:10px">
            <button class="btn secondary" onclick="pickProfile('math_geo')" data-i18n="prof_math_geo">Математика – География</button>
            <button class="btn secondary" onclick="pickProfile('math_phys')" data-i18n="prof_math_phys">Математика – Физика</button>
            <button class="btn secondary" onclick="pickProfile('bio_geo')" data-i18n="prof_bio_geo">Биология – География</button>
            <button class="btn secondary" onclick="pickProfile('bio_chem')" data-i18n="prof_bio_chem">Биология – Химия</button>
            <button class="btn secondary" onclick="pickProfile('chem_phys')" data-i18n="prof_chem_phys">Химия – Физика</button>
            <button class="btn secondary" onclick="pickProfile('geo_lang')" data-i18n="prof_geo_lang">География – Шет тілі</button>
            <button class="btn secondary" onclick="pickProfile('math_inf')" data-i18n="prof_math_inf">Математика – Информатика</button>
            <button class="btn secondary" onclick="pickProfile('creative')" data-i18n="prof_creative">Творческий экзамен (Дизайн)</button>
          </div>

          <!-- PROGRAMS (UI only) -->
          <div id="programsWrap" class="card" style="padding:14px; margin-top:12px; display:none">
            <div class="small">Бағдарламалар (демо)</div>
            <div id="programsList" class="p" style="margin-top:10px; line-height:1.75"></div>
          </div>
        </div>
      </div>

      <!-- STEP 2b: COLLEGE PROGRAM LIST (UI only) -->
      <div id="collegePrograms" style="display:none; margin-top:14px">
        <div class="card" style="padding:14px">
          <div class="small">Колледжден кейін (2 пән) — бағдарламалар</div>
          <div id="collegeList" class="p" style="margin-top:10px; line-height:1.75"></div>
        </div>
      </div>

      <div id="actions" style="display:none; margin-top:14px">
        <div class="grid two">
          <button class="btn secondary" onclick="resetAll()" data-i18n="btn_back">Артқа</button>
          <button class="btn" onclick="issueTicket()" data-i18n="adm_get_ticket">Талон алу</button>
        </div>
      </div>

      <p class="small" style="margin-top:12px">
        * Бұл прототип: нақты құжаттар/бағдарламалар кейін толықтырылады.
      </p>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="{% static 'assets/js/i18n.js' %}"></script>
  <script src="{% static 'assets/js/ui.js' %}"></script>
  <script src="{% static 'assets/js/app.js' %}"></script>

  <script>
    APP.load();
    I18N.load();

    if(!APP.state.verified){
      showToast(I18N.t("msg_need_verify"));
      setTimeout(()=> go('/app/register/'), 400);
    }

    let category = null;
    let profile = null;
    let programs = []; // UI only

    function chooseCategory(cat){
      category = cat;
      profile = null;
      programs = [];

      document.getElementById("docs").style.display = "block";
      document.getElementById("docsList").innerHTML = [
        "• Конкурсқа құжаттардың түпнұсқасы және көшірмесі қажет",
        "• Медициналық құжаттар талап етілмеуі мүмкін (прототип)",
        "• Көшірмелерді тех. хатшы жанында жасауға болады"
      ].join("<br>");

      const needProfile = (cat === "after11" || cat === "foreign");
      document.getElementById("profileWrap").style.display = needProfile ? "block" : "none";

      const isCollege = (cat === "afterCollege");
      document.getElementById("collegePrograms").style.display = isCollege ? "block" : "none";

      if(isCollege){
        document.getElementById("collegeList").innerHTML =
          getCollegePrograms().map(x => "• " + x).join("<br>");
      }

      document.getElementById("actions").style.display = "block";

      hideProgramsPanel();
      document.querySelectorAll("#profileWrap .btn").forEach(b => b.classList.remove("active"));
    }

    function resetAll(){
      category = null; profile = null; programs = [];
      document.getElementById("docs").style.display = "none";
      document.getElementById("profileWrap").style.display = "none";
      document.getElementById("collegePrograms").style.display = "none";
      document.getElementById("actions").style.display = "none";
      hideProgramsPanel();
    }

    function hideProgramsPanel(){
      const wrap = document.getElementById("programsWrap");
      const list = document.getElementById("programsList");
      if(wrap){ wrap.classList.remove("reveal","show"); wrap.style.display="none"; }
      if(list){ list.innerHTML = ""; }
    }

    function pickProfile(p){
      profile = p;

      document.querySelectorAll("#profileWrap .btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll("#profileWrap .btn").forEach(b => {
        if((b.getAttribute("onclick") || "").includes(`'${p}'`)) b.classList.add("active");
      });

      programs = getProgramsByProfile(p);
      const list = document.getElementById("programsList");
      list.innerHTML = programs.length ? programs.map(x => "• " + x).join("<br>")
                                       : "• (Тізім кейін қосылады)";

      const wrap = document.getElementById("programsWrap");
      wrap.style.display = "block";
      wrap.classList.add("reveal");
      requestAnimationFrame(() => wrap.classList.add("show"));
    }

    function getProgramsByProfile(p){
      const base = {
        math_geo: ["6B04101 – Экономика", "6B04102 – Менеджмент", "6B04106 – Қаржы"],
        math_phys: ["6B07103 – Автоматтандыру", "6B07104 – Робототехника", "6B07109 – Цифрлық энергетика"],
        bio_geo: ["6B05201 – Экология", "6B11101 – Туризм"],
        bio_chem: ["6B05101 – Биотехнология", "6B07203 – Фармацевтикалық өндіріс"],
        chem_phys: ["6B07101 – Химиялық технология", "6B07202 – Қайта өңдеу өндірістері"],
        geo_lang: ["6B11101 – Туризм", "6B11102 – Ресторан ісі және қонақүй бизнесі"],
        math_inf: ["6B06101 – Ақпараттық жүйелер", "6B06103 – Бағдарламалық инженерия", "6B06104 – AI технологиялары"],
        creative: ["6B02101 – Дизайн", "6B02102 – Fashion дизайн"]
      };
      return base[p] || [];
    }

    function getCollegePrograms(){
      return [
        "6B04101 – Экономика",
        "6B04102 – Менеджмент",
        "6B04103 – Мемлекеттік және жергілікті басқару",
        "6B04105 – Учет и аудит",
        "6B04106 – Финансы",
        "6B07109 – Цифровая энергетика",
        "6B07103 – Автоматизация и управление",
        "6B07104 – Роботы и робототехнические системы",
        "6B07105 – Технологические машины и оборудование",
        "6B07201 – Технология продовольственных продуктов",
        "6B06101 – Информационные системы",
        "6B06102 – Вычислительная техника и ПО",
        "6B06103 – Программная инженерия",
        "6B06104 – Технологии искусственного интеллекта",
        "6B02101 – Дизайн",
        "6B02102 – Fashion дизайн"
      ];
    }

    async function issueTicket(){
      if(!category){
        showToast("Категорияны таңдаңыз");
        return;
      }

      if((category === "after11" || category === "foreign") && !profile){
        showToast("Профильдік пәндерді таңдаңыз");
        return;
      }

      // ✅ отправляем только то, что нужно backend
      const payload = {
        service: "contest",
        pay_type: "grant",
        category: category,
        profile: profile || "",
        fio: APP.state.fio,
        phone: APP.state.phone
      };

      try{
        const created = await apiCreateTicket(payload); // backend вернёт number/desk/status/created_at
        saveTicket(created);
        go("/app/done/");
      }catch(e){
        showToast("API error: " + (e?.message || e));
      }
    }
  </script>
  <!-- Новые анимации -->
<script src="{% static 'assets/js/animations.js' %}"></script>
</body>
</html>
